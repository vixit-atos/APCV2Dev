public with sharing class TWSSpecImporter {

    static String CONCs = '<?xml version="1.0" encoding="utf-8"?> <entry xml:base="http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/" xmlns="http://www.w3.org/2005/Atom" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCs(\'5J0087\')</id> <category term="TDB2Model.CONC" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONC" href="CONCs(\'5J0087\')" /> <title /> <updated>2016-09-10T00:13:54Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:CTRY_CD>203</d:CTRY_CD> <d:CONC_REPLD_NO xml:space="preserve">      </d:CONC_REPLD_NO> <d:CONC_REPLS_NO xml:space="preserve">      </d:CONC_REPLS_NO> <d:LEAD_CONC_NO>5J0087</d:LEAD_CONC_NO> <d:SO_CD>CTXD</d:SO_CD> <d:DIST_MGR_NAME xml:space="preserve">SCOTT SCHRIVER                </d:DIST_MGR_NAME> <d:CONT_PRSN_NAME_42 xml:space="preserve">PHIL RAY                                  </d:CONT_PRSN_NAME_42> <d:CUST_NAME_50 xml:space="preserve">CATAWBA TRUCK RENTAL INC                          </d:CUST_NAME_50> <d:CITY xml:space="preserve">CLAREMONT           </d:CITY> <d:ST_CD>NC</d:ST_CD> <d:CREATED_BY_LID>QSCTXD01</d:CREATED_BY_LID> <d:AUTH_INITS>TRC</d:AUTH_INITS> <d:AUTH_APPR_LID xml:space="preserve">JUSLS47 </d:AUTH_APPR_LID> <d:AUTH_UPDT_INITS xml:space="preserve">   </d:AUTH_UPDT_INITS> <d:UPDT_LID xml:space="preserve">JF04258 </d:UPDT_LID> <d:CONC_VEH_MDL_NO xml:space="preserve">PX125064S T </d:CONC_VEH_MDL_NO> <d:RQST_MIN_UNITS m:type="Edm.Decimal">115</d:RQST_MIN_UNITS> <d:APPR_MIN_UNITS m:type="Edm.Decimal">115</d:APPR_MIN_UNITS> <d:RQST_MAX_UNITS m:type="Edm.Decimal">115</d:RQST_MAX_UNITS> <d:APPR_MAX_UNITS m:type="Edm.Decimal">115</d:APPR_MAX_UNITS> <d:TOT_UNITS_ENT m:type="Edm.Decimal">0</d:TOT_UNITS_ENT> <d:DOL m:type="Edm.DateTime">2016-06-07T00:00:00</d:DOL> <d:DATE_APPR m:type="Edm.DateTime">2016-07-26T00:00:00</d:DATE_APPR> <d:EXPR_DATE m:type="Edm.DateTime">2018-09-30T00:00:00</d:EXPR_DATE> <d:DATE_DLR_RQST m:type="Edm.DateTime">2016-06-07T00:00:00</d:DATE_DLR_RQST> <d:DATE_LAST_PRTD m:type="Edm.DateTime">2016-07-28T00:00:00</d:DATE_LAST_PRTD> <d:INVC_CONC_AMT m:type="Edm.Decimal">0</d:INVC_CONC_AMT> <d:CR_AMT m:type="Edm.Decimal">0</d:CR_AMT> <d:DLR_COMMSN m:type="Edm.Decimal">0</d:DLR_COMMSN> <d:RQST_CONC_AMT m:type="Edm.Decimal">84669</d:RQST_CONC_AMT> <d:EST_DLR_PROF m:type="Edm.Decimal">1950</d:EST_DLR_PROF> <d:DLR_BASE_MDL_PRC m:type="Edm.Decimal">162873</d:DLR_BASE_MDL_PRC> <d:DLR_OPT_PRC m:type="Edm.Decimal">32217</d:DLR_OPT_PRC> <d:BASE_MDL_PROF_EST m:type="Edm.Decimal">90132</d:BASE_MDL_PROF_EST> <d:DLR_OPT_PROF_EST m:type="Edm.Decimal">17397</d:DLR_OPT_PROF_EST> <d:FIXD_OVHD_AMT m:type="Edm.Decimal">0</d:FIXD_OVHD_AMT> <d:CONC_PCT_SALE m:type="Edm.Decimal">0.00</d:CONC_PCT_SALE> <d:CONC_PCT_FIXD_COST m:type="Edm.Decimal">0.00</d:CONC_PCT_FIXD_COST> <d:FTL_PROF_MRGN_PCT m:type="Edm.Decimal">0</d:FTL_PROF_MRGN_PCT> <d:RQST_CONC_PCT m:type="Edm.Decimal">43.40</d:RQST_CONC_PCT> <d:APPR_CONC_PCT m:type="Edm.Decimal">42.60</d:APPR_CONC_PCT> <d:RQST_CONC_PCT_INDC>Y</d:RQST_CONC_PCT_INDC> <d:APPR_CONC_PCT_INDC>Y</d:APPR_CONC_PCT_INDC> <d:RQST_IN_GDLNS_INDC xml:space="preserve"> </d:RQST_IN_GDLNS_INDC> <d:TRADE_INVOL_INDC xml:space="preserve"> </d:TRADE_INVOL_INDC> <d:DLR_FIN_AVAIL_INDC>N</d:DLR_FIN_AVAIL_INDC> <d:EXT_EXPR_DATE_INDC xml:space="preserve"> </d:EXT_EXPR_DATE_INDC> <d:CACCTG_PREP_INDC xml:space="preserve"> </d:CACCTG_PREP_INDC> <d:FTL_FIN_LIAB_INDC xml:space="preserve"> </d:FTL_FIN_LIAB_INDC> <d:RSD_VALU_APPR_INDC xml:space="preserve"> </d:RSD_VALU_APPR_INDC> <d:RSD_IN_GDLNS_INDC xml:space="preserve"> </d:RSD_IN_GDLNS_INDC> <d:CLTR_PRT_RQST_INDC xml:space="preserve"> </d:CLTR_PRT_RQST_INDC> <d:CLTR_DLR_SIGN_INDC xml:space="preserve"> </d:CLTR_DLR_SIGN_INDC> <d:UNCMP_SALE_INDC xml:space="preserve"> </d:UNCMP_SALE_INDC> <d:UNCMP_SALE_RSN_CD1 xml:space="preserve"> </d:UNCMP_SALE_RSN_CD1> <d:UNCMP_SALE_RSN_CD2 xml:space="preserve"> </d:UNCMP_SALE_RSN_CD2> <d:UNCMP_SALE_RSN_CD3 xml:space="preserve"> </d:UNCMP_SALE_RSN_CD3> <d:UNCMP_SALE_RSN_CD4 xml:space="preserve"> </d:UNCMP_SALE_RSN_CD4> <d:UNCMP_SALE_RSN_CD5 xml:space="preserve"> </d:UNCMP_SALE_RSN_CD5> <d:SLS_RGN_CD xml:space="preserve">P </d:SLS_RGN_CD> <d:SLS_DIST_CD>34</d:SLS_DIST_CD> <d:PROD_FAM_CD>F</d:PROD_FAM_CD> <d:VEH_BASE_MDL_NO xml:space="preserve">CA125SLP    </d:VEH_BASE_MDL_NO> <d:VEH_BASE_MDL_DB_CD xml:space="preserve">001-233  </d:VEH_BASE_MDL_DB_CD> <d:CUST_ACCT_NO>W76475</d:CUST_ACCT_NO> <d:ADDR_LN_1_20 xml:space="preserve">PO BOX 339          </d:ADDR_LN_1_20> <d:ADDR_LN_2_20 xml:space="preserve">                    </d:ADDR_LN_2_20> <d:VEH_FRT_COST m:type="Edm.Decimal">2000.00</d:VEH_FRT_COST> <d:REF_CONC_NO xml:space="preserve">      </d:REF_CONC_NO> <d:PREDM_OEM_FLT xml:space="preserve">   </d:PREDM_OEM_FLT> <d:NO_VEHS_BUS m:type="Edm.Decimal">0</d:NO_VEHS_BUS> <d:POTL_SLS_NXT_YR m:type="Edm.Decimal">0</d:POTL_SLS_NXT_YR> <d:TOT_MIN_UNITS m:type="Edm.Decimal">250</d:TOT_MIN_UNITS> <d:TOT_MAX_UNITS m:type="Edm.Decimal">300</d:TOT_MAX_UNITS> <d:APPR_CONC_AMT m:type="Edm.Decimal">83108</d:APPR_CONC_AMT> <d:EST_QQ_CAT_I_AMT m:type="Edm.Decimal">0</d:EST_QQ_CAT_I_AMT> <d:EST_QQ_CAT_II_AMT m:type="Edm.Decimal">0</d:EST_QQ_CAT_II_AMT> <d:EST_QQ_CAT_III_AMT m:type="Edm.Decimal">0</d:EST_QQ_CAT_III_AMT> <d:EST_QQ_CAT_IV_AMT m:type="Edm.Decimal">0</d:EST_QQ_CAT_IV_AMT> <d:DLR_NET_PRC m:type="Edm.Decimal">195090</d:DLR_NET_PRC> <d:FET m:type="Edm.Decimal">13815</d:FET> <d:SELL_PRC m:type="Edm.Decimal">115932</d:SELL_PRC> <d:TRAN_PRC m:type="Edm.Decimal">129820</d:TRAN_PRC> <d:CONC_STATUS_CD>030</d:CONC_STATUS_CD> <d:REF_VEH_SER_NO xml:space="preserve">      </d:REF_VEH_SER_NO> <d:FTS_PRT_DATE m:type="Edm.DateTime" m:null="true" /> <d:FTS_PRT_TIME m:type="Edm.Time" m:null="true" /> <d:FTS_PRT_LID xml:space="preserve">JUSLS47 </d:FTS_PRT_LID> <d:TYPE_OF_BUS xml:space="preserve">                              </d:TYPE_OF_BUS> <d:OPT_PROF_EST m:type="Edm.Decimal">0</d:OPT_PROF_EST> <d:HIGH_PRTY_INDC xml:space="preserve"> </d:HIGH_PRTY_INDC> <d:TOL m:type="Edm.Time">PT7H22M19S</d:TOL> <d:ZIP_CD xml:space="preserve">28168    </d:ZIP_CD> <d:CUST_TYPE_CD>S</d:CUST_TYPE_CD> <d:TIRE_PRC m:type="Edm.Decimal">195</d:TIRE_PRC> <d:DLR_OVERALLOW m:type="Edm.Decimal">0</d:DLR_OVERALLOW> <d:DLR_PGM_TOT_AMT m:type="Edm.Decimal">0</d:DLR_PGM_TOT_AMT> <d:DLR_OPT_TOT_AMT m:type="Edm.Decimal">0</d:DLR_OPT_TOT_AMT> <d:DLR_CAC_TOT_AMT m:type="Edm.Decimal">755</d:DLR_CAC_TOT_AMT> <d:SPPRO_ORD_ID xml:space="preserve">          </d:SPPRO_ORD_ID> <d:SPPRO_SPEC_ID xml:space="preserve">          </d:SPPRO_SPEC_ID> <d:CTRADE_INVOL_INDC xml:space="preserve"> </d:CTRADE_INVOL_INDC> <d:APPR_NET_CNTRB m:type="Edm.Decimal">21821</d:APPR_NET_CNTRB> <d:APPR_NET_CNTRB_TS m:type="Edm.DateTime">2016-07-28T13:40:21.329204</d:APPR_NET_CNTRB_TS> <d:DOA_RESP_LID xml:space="preserve">JSALS35 </d:DOA_RESP_LID> <d:SPPRO_ORD_TSOL>160607072219</d:SPPRO_ORD_TSOL> <d:OPT_MRGN_PRC m:type="Edm.Decimal">400</d:OPT_MRGN_PRC> <d:OPT_MRGN_INDC xml:space="preserve"> </d:OPT_MRGN_INDC> <d:WEB_DSPLY_INDC xml:space="preserve"> </d:WEB_DSPLY_INDC> <d:GDLN_SEG_TYPE_CD xml:space="preserve">  </d:GDLN_SEG_TYPE_CD> <d:GDLN_ACCT_TYPE_CD>NN</d:GDLN_ACCT_TYPE_CD> <d:GDLN_MKT_SEG_TYPCD xml:space="preserve">  </d:GDLN_MKT_SEG_TYPCD> <d:DEAL_CMPLT_DATE m:type="Edm.DateTime" m:null="true" /> <d:MAN_DISCR_ADJ_PCT m:type="Edm.Decimal">0.00</d:MAN_DISCR_ADJ_PCT> <d:EXCL_DISCR_INDC>N</d:EXCL_DISCR_INDC> <d:MAN_DISCR_ADJ_RSN xml:space="preserve">                                                            </d:MAN_DISCR_ADJ_RSN> <d:DEAL_CMPLT_INDC>N</d:DEAL_CMPLT_INDC> <d:DNET_PGM_AMT_TOT m:type="Edm.Decimal">0</d:DNET_PGM_AMT_TOT> <d:PGM_DISCR_PCT_TOT m:type="Edm.Decimal">0.00</d:PGM_DISCR_PCT_TOT> <d:PRC_METH_TYPE_CD>Y</d:PRC_METH_TYPE_CD> <d:RAW_MATL_INCR_INDC xml:space="preserve"> </d:RAW_MATL_INCR_INDC> <d:GROSS_CNTRB_AMT m:type="Edm.Decimal">0.00</d:GROSS_CNTRB_AMT> <d:OCA_GEN_CNTRB_INDC xml:space="preserve"> </d:OCA_GEN_CNTRB_INDC> <d:RMS_START_DATE m:type="Edm.DateTime" m:null="true" /> <d:RMS_TRIG_PCT m:type="Edm.Decimal">2.00</d:RMS_TRIG_PCT> <d:RMS_DELTA_PCT m:type="Edm.Decimal">75.00</d:RMS_DELTA_PCT> <d:RMS_RECALC_PER xml:space="preserve">F </d:RMS_RECALC_PER> <d:GLDR_INDC>N</d:GLDR_INDC> <d:DLU m:type="Edm.DateTime" m:null="true" /> <d:TS_LAST_UPDT m:type="Edm.DateTime" m:null="true" /> <d:APV m:type="Edm.Decimal">399</d:APV> </m:properties> </content> </entry>';
    static String Invoice_Header = '<?xml version="1.0" encoding="utf-8"?> <feed xml:base="http://cpdxdweb003:8181/WebInvoiceService/WebInvoiceService.svc/" xmlns="http://www.w3.org/2005/Atom" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"> <id>http://cpdxdweb003:8181/WebInvoiceService/WebInvoiceService.svc/Invoice_Header</id> <title type="text">Invoice_Header</title> <updated>2016-09-02T22:26:29Z</updated> <link rel="self" title="Invoice_Header" href="Invoice_Header" /> <entry> <id>http://cpdxdweb003:8181/WebInvoiceService/WebInvoiceService.svc/Invoice_Header(invc_no=\'R55790_20\',veh_ser_no=\'HD2944\')</id> <category term="Web_InvoiceModel.Invoice_Header" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="Invoice_Header" href="Invoice_Header(invc_no=\'R55790_20\',veh_ser_no=\'HD2944\')" /> <title /> <updated>2016-09-02T22:26:29Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:veh_ser_no>HD2944</d:veh_ser_no> <d:invc_no xml:space="preserve">R55790 </d:invc_no> <d:void_ind>N</d:void_ind> <d:vin_no>1FUJGLDR5HLHD2944</d:vin_no> <d:tso_split_no>HD2934</d:tso_split_no> <d:so_cd>CTXD</d:so_cd> <d:so_branch_loc>00</d:so_branch_loc> <d:so_reg_cd xml:space="preserve">P </d:so_reg_cd> <d:so_dist_cd>34</d:so_dist_cd> <d:tso_tso_no xml:space="preserve">011915    </d:tso_tso_no> <d:price_lvl_cd>PRL-10C</d:price_lvl_cd> <d:retail_sold_cust_no xml:space="preserve">      </d:retail_sold_cust_no> <d:invc_date>2016-06-07</d:invc_date> <d:date_invc_pymt_due>2016-06-21</d:date_invc_pymt_due> <d:fin_inst_cd>F000</d:fin_inst_cd> <d:eng_ser_no xml:space="preserve">472910S0431681      </d:eng_ser_no> <d:trans_ser_no xml:space="preserve">                    </d:trans_ser_no> <d:front_axle_wt>0000000</d:front_axle_wt> <d:rear_axle_wt>0000000</d:rear_axle_wt> <d:gvwr>0000000</d:gvwr> <d:glider_cd>N</d:glider_cd> <d:veh_mdl_no>PX125064S T</d:veh_mdl_no> <d:purch_ord_no>............</d:purch_ord_no> <d:build_loc xml:space="preserve">CLEVELAND TMP  </d:build_loc> <d:stock_orr_actual_cd>C</d:stock_orr_actual_cd> <d:prod_fam_cd>F</d:prod_fam_cd> <d:veh_make>FTL</d:veh_make> <d:veh_base_mdl_no xml:space="preserve">CA125SLP    </d:veh_base_mdl_no> <d:dealer_net_amt xml:space="preserve"> 0192859.05</d:dealer_net_amt> <d:conc_no>5I4792</d:conc_no> <d:conc_amt>-0080827.00</d:conc_amt> <d:sug_rtl_amt xml:space="preserve"> 0226893.00</d:sug_rtl_amt> <d:invc_amt xml:space="preserve"> 0120137.05</d:invc_amt> <d:forn_lang_cd>EN</d:forn_lang_cd> <d:sold_to_name xml:space="preserve">WEST CAROLINA FREIGHTLINER, LLC                   </d:sold_to_name> <d:sold_to_addr1 xml:space="preserve">PO BOX 370                                        </d:sold_to_addr1> <d:sold_to_addr2 xml:space="preserve">                                                  </d:sold_to_addr2> <d:sold_to_city xml:space="preserve">HILDEBRAN           </d:sold_to_city> <d:sold_to_st>NC</d:sold_to_st> <d:sold_to_zip xml:space="preserve">28637     </d:sold_to_zip> <d:cust_name xml:space="preserve">CATAWBA TRUCK RENTAL                              </d:cust_name> <d:cust_addr1 xml:space="preserve">PO BOX 339                                        </d:cust_addr1> <d:cust_addr2 xml:space="preserve">                                                  </d:cust_addr2> <d:cust_city xml:space="preserve">CLAREMONT           </d:cust_city> <d:cust_st>NC</d:cust_st> <d:cust_zip xml:space="preserve">28168     </d:cust_zip> <d:payer_name xml:space="preserve">DAIMLER TRUCK FINANCIAL                           </d:payer_name> <d:payer_addr1 xml:space="preserve">1011 WARRENVILLE RD, SUITE 600                    </d:payer_addr1> <d:payer_addr2 xml:space="preserve">SUITE 700                                         </d:payer_addr2> <d:payer_city xml:space="preserve">LISLE               </d:payer_city> <d:payer_st>IL</d:payer_st> <d:payer_zip xml:space="preserve">60532     </d:payer_zip> <d:inv_adj_ind xml:space="preserve"> </d:inv_adj_ind> <d:tco_ind xml:space="preserve"> </d:tco_ind> <d:rds_adj_pct m:type="Edm.Decimal">-15.0000</d:rds_adj_pct> <d:disc_module_no>RCN</d:disc_module_no> <d:cvrt_indc>Y</d:cvrt_indc> <d:Date_Invc_Rqst>2016-06-07</d:Date_Invc_Rqst> <d:Qty_Split xml:space="preserve">011  </d:Qty_Split> <d:cust_acct_no>W76475</d:cust_acct_no> </m:properties> </content> </entry> </feed>';
    static String CONMCDB = '<?xml version="1.0" encoding="utf-8"?> <feed xml:base="http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/" xmlns="http://www.w3.org/2005/Atom" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs</id> <title type="text">CONCMCDBs</title> <updated>2016-09-10T01:03:04Z</updated> <link rel="self" title="CONCMCDBs" href="CONCMCDBs" /> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'A84-1GF%20%20\',DB_SLS_DESC1=\'GENERAL%20FREIGHT%20BUSINESS%20SEGMENT%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'A84-1GF%20%20\',DB_SLS_DESC1=\'GENERAL%20FREIGHT%20BUSINESS%20SEGMENT%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">A84-1GF  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">GENERAL FREIGHT BUSINESS SEGMENT        </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">                                        </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'A85-005%20%20\',DB_SLS_DESC1=\'LINEHAUL/LONG%20HAUL%20SERVICE%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'A85-005%20%20\',DB_SLS_DESC1=\'LINEHAUL/LONG%20HAUL%20SERVICE%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">A85-005  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">LINEHAUL/LONG HAUL SERVICE              </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">                                        </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'001-233%20%20\',DB_SLS_DESC1=\'CASCADIA%20125%20INCH%20SLEEPERCAB%20%20%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'001-233%20%20\',DB_SLS_DESC1=\'CASCADIA%20125%20INCH%20SLEEPERCAB%20%20%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">001-233  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">CASCADIA 125 INCH SLEEPERCAB            </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">                                        </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'002-002%20%20\',DB_SLS_DESC1=\'SET%20BACK%20AXLE%20-%20TRACTOR%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'002-002%20%20\',DB_SLS_DESC1=\'SET%20BACK%20AXLE%20-%20TRACTOR%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">002-002  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">SET BACK AXLE - TRACTOR                 </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">                                        </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'093-1KH%20%20\',DB_SLS_DESC1=\'MICHELIN%20X%20LINE%20ENERGY%20Z%20275/80R22.5%2016%20\',DB_SLS_DESC2=\'%20PLY%20RADIAL%20FRONT%20TIRES%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'093-1KH%20%20\',DB_SLS_DESC1=\'MICHELIN%20X%20LINE%20ENERGY%20Z%20275/80R22.5%2016%20\',DB_SLS_DESC2=\'%20PLY%20RADIAL%20FRONT%20TIRES%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">093-1KH  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">MICHELIN X LINE ENERGY Z 275/80R22.5 16 </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve"> PLY RADIAL FRONT TIRES                 </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'094-1MC%20%20\',DB_SLS_DESC1=\'MICHELIN%20X-ONE%20XDN2%20445/50R22.5%2020%20PLY%20R\',DB_SLS_DESC2=\'RADIAL%20REAR%20TIRES%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'094-1MC%20%20\',DB_SLS_DESC1=\'MICHELIN%20X-ONE%20XDN2%20445/50R22.5%2020%20PLY%20R\',DB_SLS_DESC2=\'RADIAL%20REAR%20TIRES%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">094-1MC  </d:DB_CD> <d:DB_SLS_DESC1>MICHELIN X-ONE XDN2 445/50R22.5 20 PLY R</d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">RADIAL REAR TIRES                       </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'101-2YG%20%20\',DB_SLS_DESC1=\'DETROIT%20DD15%2014.8L%20475%20HP%20%40%201625%20RPM%2C%2019\',DB_SLS_DESC2=\'900%20GOV%20RPM%2C%201650%20LB/FT%20%40%20975%20RPM%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'101-2YG%20%20\',DB_SLS_DESC1=\'DETROIT%20DD15%2014.8L%20475%20HP%20%40%201625%20RPM%2C%2019\',DB_SLS_DESC2=\'900%20GOV%20RPM%2C%201650%20LB/FT%20%40%20975%20RPM%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">101-2YG  </d:DB_CD> <d:DB_SLS_DESC1>DETROIT DD15 14.8L 475 HP @ 1625 RPM, 19</d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">900 GOV RPM, 1650 LB/FT @ 975 RPM       </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'342-189%20%20\',DB_SLS_DESC1=\'DT12-DA-1650%20HEAVY%20DUTY%2012-SPEED%20DIRECT%20\',DB_SLS_DESC2=\'%20DRIVE%20AUTOMATED%20MANUAL%20TRANSMISSION%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'342-189%20%20\',DB_SLS_DESC1=\'DT12-DA-1650%20HEAVY%20DUTY%2012-SPEED%20DIRECT%20\',DB_SLS_DESC2=\'%20DRIVE%20AUTOMATED%20MANUAL%20TRANSMISSION%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">342-189  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">DT12-DA-1650 HEAVY DUTY 12-SPEED DIRECT </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve"> DRIVE AUTOMATED MANUAL TRANSMISSION    </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'400-097%20%20\',DB_SLS_DESC1=\'MFS-13-143A%2013%2C300%23%20FF1%2071.5%20INCH%20KPI/3.\',DB_SLS_DESC2=\'.74%20INCH%20DROP%20SINGLE%20FRONT%20AXLE%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'400-097%20%20\',DB_SLS_DESC1=\'MFS-13-143A%2013%2C300%23%20FF1%2071.5%20INCH%20KPI/3.\',DB_SLS_DESC2=\'.74%20INCH%20DROP%20SINGLE%20FRONT%20AXLE%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">400-097  </d:DB_CD> <d:DB_SLS_DESC1>MFS-13-143A 13,300# FF1 71.5 INCH KPI/3.</d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">.74 INCH DROP SINGLE FRONT AXLE         </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'420-1N5%20%20\',DB_SLS_DESC1=\'MT-40-14X%2040%2C000%23%20R-SERIES%20DUALTRAC%2074-7\',DB_SLS_DESC2=\'77%20INCH%20INTERMEDIATE%20TRACK%20TANDEM%20REAR%20A\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'420-1N5%20%20\',DB_SLS_DESC1=\'MT-40-14X%2040%2C000%23%20R-SERIES%20DUALTRAC%2074-7\',DB_SLS_DESC2=\'77%20INCH%20INTERMEDIATE%20TRACK%20TANDEM%20REAR%20A\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">420-1N5  </d:DB_CD> <d:DB_SLS_DESC1>MT-40-14X 40,000# R-SERIES DUALTRAC 74-7</d:DB_SLS_DESC1> <d:DB_SLS_DESC2>77 INCH INTERMEDIATE TRACK TANDEM REAR A</d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'682-077%20%20\',DB_SLS_DESC1=\'72%20INCH%20RAISED%20ROOF%20SLEEPERCAB%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'682-077%20%20\',DB_SLS_DESC1=\'72%20INCH%20RAISED%20ROOF%20SLEEPERCAB%20%20%20%20%20%20%20%20%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">682-077  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">72 INCH RAISED ROOF SLEEPERCAB          </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">                                        </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> <entry> <id>http://cpdxdweb003:9080/WebInvoiceServiceDBTwo/WebInvoiceServiceDB.svc/CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'829-1AF%20%20\',DB_SLS_DESC1=\'125%20INCH%20BBC%20ALUMINUM%20CONVENTIONAL%20CAB%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')</id> <category term="TDB2Model.CONCMCDB" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /> <link rel="edit" title="CONCMCDB" href="CONCMCDBs(CONC_NO=\'5J0087\',DB_CD=\'829-1AF%20%20\',DB_SLS_DESC1=\'125%20INCH%20BBC%20ALUMINUM%20CONVENTIONAL%20CAB%20%20\',DB_SLS_DESC2=\'%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20\',DLU=datetime\'2016-06-07T00%3A00%3A00\',UPDT_LID=\'QSCTXD01\')" /> <title /> <updated>2016-09-10T01:03:04Z</updated> <author> <name /> </author> <content type="application/xml"> <m:properties> <d:CONC_NO>5J0087</d:CONC_NO> <d:DB_CD xml:space="preserve">829-1AF  </d:DB_CD> <d:DB_SLS_DESC1 xml:space="preserve">125 INCH BBC ALUMINUM CONVENTIONAL CAB  </d:DB_SLS_DESC1> <d:DB_SLS_DESC2 xml:space="preserve">                                        </d:DB_SLS_DESC2> <d:DLU m:type="Edm.DateTime">2016-06-07T00:00:00</d:DLU> <d:UPDT_LID>QSCTXD01</d:UPDT_LID> </m:properties> </content> </entry> </feed>';


    Map<string, Map<string, List<string>>> importMap;
    List<PricingProposalDynamicLineItem__c> dliList;
    List<Controlling_Line_Item__c> cliList;
    PricingProposal__c p;
    Opportunity o;
    RecordType rt;
    String currencyIsoStr  = 'USD';

    public TWSSpecImporter() {}

    public TWSSpecImporter(PricingProposal__c proposal) {
        importMap = new Map<string, Map<string, List<string>>>();
        dliList = new List<PricingProposalDynamicLineItem__c>();
        cliList = new List<Controlling_Line_Item__c>();

        p = proposal;

        o =  [select
              RecordTypeId,
              CMPTR_CD__c,
              DATE_DELV_RQST__c,
              DATE_LATEST_ACCEPT__c,
              PriceProtect__c,
              OrderReceivedFrom__c,
              OrderReceivedTo__c,
              Escalators__c,
              SO_CD__c from Opportunity where id = :p.Opportunity__c];
        rt = [select DeveloperName, Id from RecordType where id = :o.RecordTypeId];

        if (rt.DeveloperName == 'TWS_TC_Canadian_Deal') {
            currencyIsoStr = 'CAD';
            

        }

    //  p.CurrencyIsoCode = currencyIsoStr;

        //set currency
        //set record type for pricing proposal / contribution calculation




    }

    void printMap(Map<string, List<string>> escMap) {

        List<String> dliString;



        for (String key : escMap.keySet()) {

            if (escMap.containsKey(key)) {


                dliString = escMap.get(key);

                if (dliString != null) {


                    for (String element : dliString) {

                        System.debug(key + ' : ' + element);


                    }
                }

            }
        }


    }




    void updatePricingProposal() {


        Map<string, List<string>> mcMap;
        SObject so;
        String[] s;
        Integer index;



        for (TWS_Data_Map__c m : TWS_Data_Map__c.getAll().values()) {


            if (importMap.containsKey(m.Source_Table__c)) {

                mcMap = importMap.get(m.Source_Table__c);

                if ( m.Dest_Object__c == 'Opportunity')  {
                    so =  o;
                } else {
                    so = p;
                }

                if (mcMap.containsKey(m.Source_Field__c)) {

                    //System.debug('Working : ' + m.Source_Field__c + ' : ' + mcMap.get(m.Source_Field__c));

                    s = mcMap.get(m.Source_Field__c);
                    index = Integer.valueOf(s[0]) == 1 ? 1 : 2;

                    if (s[index] != null && s[index] != '') {

                        if (so.get(m.Dest_Field__c) == null) {
                            //dont overwrite stuff


                            if (m.Type__c == 'Decimal') {

                                so.put(m.Dest_Field__c, Decimal.valueOf(s[index]));

                            } else if (m.Type__c == 'Date') {
                                //System.debug(Anydatatype_msg);
                                if (m.Dest_Field__c == 'DATE_DELV_RQST__c') {
                                    System.debug('DATE_DELV_RQST__c' + s);
                                    index =  5;
                                } else if (m.Dest_Field__c =='DATE_LATEST_ACCEPT__c') {
                                    index = 6;
                                    System.debug('DATE_LATEST_ACCEPT__c' + s);
                                } 


                                so.put(m.Dest_Field__c, Date.valueOf(s[index]));

                            } else {
                                if (m.Dest_Field__c == 'PriceProtect__c') {
                                    index = 7;
                                    s[index] = s[index] == 'Y' ? 'Yes' : 'No';
                                }
                                so.put(m.Dest_Field__c, s[index]);
                            }
                        }
                    }

                }
            }
        }

    }







    Map<string, List<string>> gen3map(Map<string, List<string>> input) {
        Map<string, List<string>> output = new Map<string, List<string>>();


        for (String key : input.keySet()) {
            output.put(key.left(3), input.get(key));
        }
        return output;

    }

    public void ImportSpecs() {



        Map<string, List<string>> currMap, currMap2;


        String base = TWS_OData_URLs__c.getInstance('url_base').URL__c;
        String url;


        //System.debug(Anydatatype_msg);

        

        if (p.ReferenceSerialNumber__c != null) {
            //let's get tire credit
        //    if (rt.DeveloperName == 'National') p.QSpec__c = p.ReferenceSerialNumber__c;

            url = base + TWS_OData_URLs__c.getInstance('GetTireCreditBySerialNo').URL__c;
            url = url.Replace('{{serial}}', p.ReferenceSerialNumber__c);

            String tc = ODataUtils.getURL(url);

            if (tc != null) {
                System.debug('Tire Credit:' + Decimal.valueOf(tc));
                p.put('Less_Tire_Credit__c',Decimal.valueOf(tc));
            }
            
            url = base + TWS_OData_URLs__c.getInstance('GetFETAmountBySerial').URL__c;
            url = url.Replace('{{serial}}', p.ReferenceSerialNumber__c);

            String fet = ODataUtils.getURL(url);

            if (fet != null) {
                System.debug('FET Amount:' + Decimal.valueOf(fet));
                p.put('FET_Exempt__c',Decimal.valueOf(fet));
            }
        
        
        } else if (p.ConcessionNumber__c != null) {
            
            url = base + TWS_OData_URLs__c.getInstance('GetTireCreditByConcNo').URL__c;
            url = url.Replace('{{conc_no}}', p.ConcessionNumber__c);

            String tc = null;
            
            try {
                tc = ODataUtils.getURL(url);
            } catch (Exception e) {
                System.debug(LoggingLevel.DEBUG, e);
            }

            if (tc != null) {
                Double tcv = Decimal.valueOf(tc);
                tcv *= -1;
                System.debug('Tire Credit:' + tcv);
                p.put('Less_Tire_Credit__c',tcv);
            }
            
            url = base + TWS_OData_URLs__c.getInstance('GetFETAmount').URL__c;
            url = url.Replace('{{conc_no}}', p.ConcessionNumber__c);

            String fet = ODataUtils.getURL(url);

            if (fet != null) {
                System.debug('FET Amount:' + Decimal.valueOf(fet));
                p.put('FET_Exempt__c',Decimal.valueOf(fet));
            }
            
            
        }

        if (p.ReferenceSerialNumber__c != null && rt.DeveloperName != 'National') {

            p.ReferenceSerialNumber__c = p.ReferenceSerialNumber__c.toUpperCase();

            currMap = new Map<string, List<string>>();

            importMap.put('Invoice_Header', currMap);

            url = base + TWS_OData_URLs__c.getInstance('Invoice_Header').URL__c;
            url = url.Replace('{{serial}}', p.ReferenceSerialNumber__c);

            ODataUtils.fillMap(ODataUtils.getProperties(ODataUtils.getOdata(url)), currMap);

            //concession % for webInvoice


            if (currMap.containsKey('conc_amt')) {
                Double conc_percent = Decimal.valueOf(currMap.get('conc_amt')[1].replaceAll('^0*', '')) /
                                      Decimal.valueOf(currMap.get('dealer_net_amt')[1].replaceAll('^0*', '')) * (-100);

                p.put('Concession_Percent__c', conc_percent);

            }



            url = base + TWS_OData_URLs__c.getInstance('InvDtDbDescs').URL__c;
            url = url.Replace('{{serial}}', p.ReferenceSerialNumber__c);

            currMap = new Map<string, List<string>>();

            importMap.put('InvDtDbDescs', currMap);
            ODataUtils.fillMap(ODataUtils.getOdata(url),
                               new String[] {'db_cd', 'db_desc_160'},
                               currMap,
                               false);

            //one off for axle config

            if (currMap.containsKey('400-') && currMap.containsKey('420-')) {
                p.put(TWS_Data_Map__c.getInstance('InvDtDbDescs.420-').Dest_Field__c, currMap.get('400-')[2] + '-|-' + currMap.get('420-')[2] );
            }

            url = base + TWS_OData_URLs__c.getInstance('Invoice_Footer').URL__c;
            url = url.Replace('{{serial}}', p.ReferenceSerialNumber__c);

            currMap = new Map<string, List<string>>();
            importMap.put('Invoice_Footer', currMap);

            ODataUtils.fillMap(ODataUtils.getOdata(url),
                               new String[] {'db_cd', 'footer_amt', 'footer_text'},
                               currMap,
                               true);

            //printMap(currMap);

            importMap.put('Invoice_Footer3', gen3map(currMap));


            //updatePricingProposal();

            //what about the column min/max units




            url = base + TWS_OData_URLs__c.getInstance('CONCs').URL__c;
            url = url.Replace('{{conc_no}}', importMap.get('Invoice_Header').get('conc_no')[1]);

            currMap = new Map<string, List<string>>();
            importMap.put('CONCs', currMap);
            ODataUtils.fillMap(ODataUtils.getProperties(ODataUtils.getOdata(url)), currMap);

            url = base + TWS_OData_URLs__c.getInstance('CONCDISCs').URL__c.Replace('{{conc_no}}', importMap.get('Invoice_Header').get('conc_no')[1]);
            currMap = new Map<string, List<string>>();
            importMap.put('CONCDISCs', currMap);
            ODataUtils.fillMap(ODataUtils.getProperties(ODataUtils.getOdata(url)), currMap);

            //let's get tire credit

            url = base + TWS_OData_URLs__c.getInstance('GetTireCreditBySerialNo').URL__c;
            url = url.Replace('{{serial}}', p.ReferenceSerialNumber__c);

            String tc = ODataUtils.getURL(url);

            if (tc != null) {
                System.debug('Tire Credit:' + Decimal.valueOf(tc));
                p.put('Less_Tire_Credit__c',Decimal.valueOf(tc));
            }

            //and fet






        }

        else if (p.ConcessionNumber__c != null) {

            p.ConcessionNumber__c = p.ConcessionNumber__c.toUpperCase();
            url = base + TWS_OData_URLs__c.getInstance('CONCs').URL__c.Replace('{{conc_no}}', p.ConcessionNumber__c);

            //pricing

            currMap = new Map<string, List<string>>();
            importMap.put('CONCs', currMap);
            ODataUtils.fillMap(ODataUtils.getProperties(ODataUtils.getOdata(url)), currMap);



            //major components

            url = base +
                  TWS_OData_URLs__c.getInstance('CONCMCDBs').URL__c.Replace('{{conc_no}}', p.ConcessionNumber__c);

            importMap.put('CONCMCDBs', currMap);
            ODataUtils.fillMap(ODataUtils.getOdata(url), new String [] {'DB_CD', 'DB_SLS_DESC1'}, currMap, false);

            if (currMap.containsKey('400-') && currMap.containsKey('420-')) {
                p.put(TWS_Data_Map__c.getInstance('CONCMCDBs.420-').Dest_Field__c, currMap.get('400-')[2] + '-|-' + currMap.get('420-')[2] );
            }


            //price level
            currMap = new Map<string, List<string>>();
            importMap.put('CONCPRCLs', currMap);
            url = base + TWS_OData_URLs__c.getInstance('CONCPRCLs').URL__c.Replace('{{conc_no}}', p.ConcessionNumber__c);
            ODataUtils.fillMap(ODataUtils.getOdata(url), new String[] {'DB_CD', 'ESC_AMT', 'NOTES_40', 'MDL_YR_DB_CD', 'DATE_DELV_RQST', 'DATE_LATEST_ACCEPT', 
                'PRC_PROT_INDC'}, currMap, true);

            

            currMap = gen3map(currMap);
            importMap.put('CONCPRCLs3', currMap);

            if (currMap.containsKey('PRL')) {
                p.PriceLevel__c = currMap.get('PRL')[1];

            }


            currMap = new Map<string, List<string>>();
            importMap.put('CONCCMPTs', currMap);
            url = base + TWS_OData_URLs__c.getInstance('CONCCMPTs').URL__c.Replace('{{conc_no}}', p.ConcessionNumber__c);
            ODataUtils.fillMap(ODataUtils.getOdata(url), new String[] {'CMPTR_CD'}, currMap, true);

            //price level



            if (o.CMPTR_CD__c == '' || o.CMPTR_CD__c == null) {
                List<String> ml = new List<string>(currMap.keyset());
                o.CMPTR_CD__c = String.join(ml,',');
            }

            currMap = new Map<string, List<string>>();
            importMap.put('VWCONCSPRECs', currMap);
            url = base + TWS_OData_URLs__c.getInstance('VWCONCSPRECs').URL__c.Replace('{{conc_no}}', p.ConcessionNumber__c);
            ODataUtils.fillMap(ODataUtils.getOdata(url), new String[] {'DB_CD', 'SPPRO_DB_CD_PRC', 'DESC_240'}, currMap, true);

            //System.debug('DLI MAP');
            //printMap(dliMap);


            url = base + TWS_OData_URLs__c.getInstance('CONCDISCs').URL__c.Replace('{{conc_no}}', p.ConcessionNumber__c);
            currMap = new Map<string, List<string>>();
            importMap.put('CONCDISCs', currMap);
            ODataUtils.fillMap(ODataUtils.getProperties(ODataUtils.getOdata(url)), currMap);


            //CONCDISCs

        }

        else if (p.QSpec__c != null) {
            p.QSpec__c = p.QSpec__c.toUpperCase();


            //base model


            url = base + + TWS_OData_URLs__c.getInstance('SSPLITNO_DPIMS').URL__c;
            url = url.Replace('{{qspec_no}}', p.QSpec__c);

            System.debug('URL' );

            currMap = new Map<string, List<string>>();
            importMap.put('SSPLITNO_DPIMS', currMap);

            ODataUtils.fillMap(ODataUtils.getProperties(ODataUtils.getOdata(url)), currMap);
            System.debug('base model');
            //printMap(mcMap);

            //majors

            url = base + + TWS_OData_URLs__c.getInstance('STSOMOD_DPIMS').URL__c;
            url = url.Replace('{{qspec_no}}', p.QSpec__c);

            currMap = new Map<string, List<string>>();
            importMap.put('STSOMOD_DPIMS', currMap);
            //printMap(importMap.get('STSOMOD_DPIMS'));

            ODataUtils.fillMap(ODataUtils.getOdata(url), new String [] {'DB_CD', 'DB_SLS_DESC1', 'DB_CD_PRICE_INCR'}, currMap, false);

            currMap = gen3map(currMap);
            importMap.put('STSOMOD_DPIMS3', currMap);

            if (currMap.containsKey('400') && currMap.containsKey('420')) {
                p.put(TWS_Data_Map__c.getInstance('STSOMOD_DPIMS.400').Dest_Field__c, currMap.get('400')[2] + '-|-' + currMap.get('420')[2] );
            }



            //dynamic line items
            url = base + TWS_OData_URLs__c.getInstance('SDBONOTE_DPIMS').URL__c;

            url = url.Replace('{{qspec_no}}', p.QSpec__c);

            currMap = new Map<string, List<string>>();
            ODataUtils.fillMap(ODataUtils.getOdata(url), new String[] {'DB_CD', 'NTE_DB_CD_PRC_INCR'}, currMap, true);
            importMap.put('SDBONOTE_DPIMS', currMap);



            if (rt.DeveloperName == 'National') {
                url = base + TWS_OData_URLs__c.getInstance('PRCADJ1_SN').URL__c;
                url = url.Replace('{{serial_no}}', p.QSpec__c);

            } else {
                url = base + TWS_OData_URLs__c.getInstance('PRCADJ1').URL__c;
                url = url.Replace('{{qspec_no}}', p.QSpec__c);
            }




            currMap = new Map<string, List<string>>();
            importMap.put('PRCADJ1', currMap);


            ODataUtils.fillMap(ODataUtils.getOdata(url), new String[] {'DB_CD', 'DB_CD_PRC_INCR', 'DB_SLS_DESC1'}, currMap, true);
            importMap.put('PRCADJ13', gen3map(currMap));


            //Now for the national accounts
            if (rt.DeveloperName == 'National') {
                url = base + TWS_OData_URLs__c.getInstance('PRCADJ1TR_SN').URL__c;
                url = url.Replace('{{serial_no}}', p.QSpec__c);

            } else {
                url = base + TWS_OData_URLs__c.getInstance('PRCADJ1TR').URL__c;
                url = url.Replace('{{qspec_no}}', p.QSpec__c);

            }



            currMap = new Map<string, List<string>>();
            importMap.put('PRCADJ1TR', currMap);


            ODataUtils.fillMap(ODataUtils.getOdata(url), new String[] {'DB_CD', 'DB_CD_PRC_INCR'}, currMap, true);


            p.Total_Retail__c = sum(importMap.get('STSOMOD_DPIMS'), 2) +
                                sum(importMap.get('SDBONOTE_DPIMS'), 1) +
                                sum(importMap.get('PRCADJ1TR'), 1);

            currMap = new Map<string, List<string>>();
            currMap.put('001', importMap.get('STSOMOD_DPIMS3').get('001'));

            System.debug('Suck it');
            //printMap(currMap);
            p.Base_Model_Retail__c = sum(currMap,2);

            //set the price level
            //printMap(importMap.get('PRCADJ13'));

            currMap = importMap.get('PRCADJ13');
            printMap(currMap);
            p.PriceLevel__c = currMap.containsKey('PRL') ? currMap.get('PRL')[1] : null;
            //printMap(importMap.get('PRCADJ13'));


        }




        //Engine warranty?

        //chassis warranty?



        updatePricingProposal();

        p.Disc_Min__c = p.NumberOfUnitsDealMin__c;

        upsert p;


        //AddDynamicLineItems(dliMap);

        addDynamicLineItems();


        insert dliList;
        update o;

    }

    Decimal sum(Map<string, List<string>> sumMap, Integer index) {

        Decimal result = 0;
        Integer modF;
        Integer count = 0;

        Decimal tv = 0;

        for (String[] records : sumMap.values()) {


            if (records != null) {

                modF = Integer.valueOf(records[0]);



                for (Integer i = 1; i < records.size(); i = i + modF) {


                    if (records[i + index] != '' && records[i + index] != null)
                        tv = Decimal.valueOf(records[i + index]);
                    result += tv;

                    if (tv != 0) {
                        count++;
                        System.debug(count + ' : ' + records);
                    }
                }
            }

        }



        return result;
    }


    void addDynamicLineItems() {

        String [] keyList;

        for (TWS_Data_Map_DLI__c m : TWS_Data_Map_DLI__c.getAll().values()) {
            if (importMap.containsKey(m.Name)) {
                keyList = m.keys__c.split(',');
                addDLI(keyList, importMap.get(m.Name));

            }

        }



    }

    void addDLI(String [] ks, Map<string, List<string>> escMap) {

        List<String> dliString;
        Integer modF;
        Decimal amount;
        String dliName;


        for (String key : ks) {

            if (escMap.containsKey(key)) {

                dliString = escMap.get(key);


                if (dliString.size() > 0) modF = integer.valueof(dliString[0]);

                for (Integer i = 1; i < dliString.Size(); i = i + modF) {

                    amount = 0;

                    try {
                        amount = Decimal.valueOf(dliString[i + 1]);
                        } catch(Exception e) {
                            System.debug(LoggingLevel.DEBUG, 'Unable to convert to decimal'+dliString[i+1]);
                        }



                    dliName = dliString[i + 2] != null || dliString[i + 2] != '' ? dliString[i + 2] : key;

                    

                    

                    if (key == 'RSC-999') {

                        //bring price level in

                        dliName = modF > 3 ? dliString[i + 3]: dliString[i + 2];


                        //populate the price escalators



                        if (o.Escalators__c == null ) {

                            o.Escalators__c = dliName +  ' $' + amount;
                        } else {

                            Set<String> eSet = new Set<String>();
                            eSet.addAll(o.Escalators__c.split(';'));
                            eSet.add(dliName + ' $' + amount);

                            o.Escalators__c = '';
                            for (String eString : eSet) {
                                o.Escalators__c += (o.Escalators__c == '' ? '' : '; ') + eString;

                            }

                        }


                    }

                    dliList.add(new PricingProposalDynamicLineItem__c(Name = dliName,
                            //  CurrencyIsoCode = currencyIsoStr,
                                Amount__c = amount,
                                PricingProposal__c = p.id));



                }

            }
        }

    }






}